<div class="completion-container">
  <!-- Header Section -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>assignment_turned_in</mat-icon>
        Training Abschluss
      </mat-card-title>
      <mat-card-subtitle>
        Verfolgen und bewerten Sie Ihre Trainings
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Date Selection -->
      <div class="date-selection">
        <mat-form-field appearance="outline">
          <mat-label>Trainingsdatum</mat-label>
          <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="onDateChange()">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Progress Summary -->
      <div class="progress-summary" *ngIf="trainings.length > 0">
        <div class="progress-stats">
          <div class="stat">
            <span class="stat-value">{{ getCompletedTrainingsCount() }}</span>
            <span class="stat-label">Abgeschlossen</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ getTotalTrainingsCount() }}</span>
            <span class="stat-label">Geplant</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ getCompletionPercentage() }}%</span>
            <span class="stat-label">Fortschritt</span>
          </div>
        </div>
        <mat-progress-bar 
          mode="determinate" 
          [value]="getCompletionPercentage()"
          class="progress-bar">
        </mat-progress-bar>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Content Tabs -->
  <mat-tab-group class="content-tabs">
    <!-- Training List Tab -->
    <mat-tab label="Trainings verwalten">
      <div class="tab-content">
        <!-- Loading -->
        <div class="loading-container" *ngIf="loading">
          <mat-spinner></mat-spinner>
          <p>Lade Trainings...</p>
        </div>

        <!-- Training List -->
        <div class="training-list" *ngIf="!loading">
          <mat-card 
            *ngFor="let training of trainings"
            class="training-card"
            [class.completed]="training.isCompleted">
            
            <mat-card-header>
              <mat-card-title>
                <div class="training-title">
                  <span class="training-name">{{ training.name }}</span>
                  <div class="training-badges">
                    <mat-chip 
                      class="type-chip"
                      [style.background-color]="getTrainingTypeColor(training.type)">
                      {{ training.type }}
                    </mat-chip>
                    <mat-chip class="intensity-chip">{{ training.intensity }}</mat-chip>
                  </div>
                </div>
              </mat-card-title>
              
              <mat-card-subtitle *ngIf="training.description">
                {{ training.description }}
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="training-details">
                <div class="detail" *ngIf="training.startTime">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ formatTime(training.startTime) }} Uhr</span>
                </div>
                <div class="detail" *ngIf="training.duration">
                  <mat-icon>timer</mat-icon>
                  <span>{{ training.duration }} min</span>
                </div>
              </div>

              <!-- Completion Status -->
              <div class="completion-status">
                <mat-icon 
                  [class.completed]="training.isCompleted"
                  [class.pending]="!training.isCompleted">
                  {{ training.isCompleted ? 'check_circle' : 'radio_button_unchecked' }}
                </mat-icon>
                <span [class.completed-text]="training.isCompleted">
                  {{ training.isCompleted ? 'Abgeschlossen' : 'Ausstehend' }}
                </span>
              </div>

              <!-- Rating Display -->
              <div class="rating-display" *ngIf="training.isCompleted && training.rating">
                <span class="rating-stars">{{ getRatingStars(training.rating) }}</span>
                <span class="rating-text">{{ training.rating }}/5</span>
              </div>

              <!-- Feedback Display -->
              <div class="feedback-display" *ngIf="training.feedback">
                <mat-icon>comment</mat-icon>
                <span>{{ training.feedback }}</span>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button 
                mat-button 
                [color]="training.isCompleted ? 'warn' : 'primary'"
                (click)="toggleTrainingCompletion(training)">
                <mat-icon>{{ training.isCompleted ? 'undo' : 'check' }}</mat-icon>
                {{ training.isCompleted ? 'Zurücksetzen' : 'Abschließen' }}
              </button>
              
              <button mat-button color="accent" (click)="openFeedbackForm(training)">
                <mat-icon>rate_review</mat-icon>
                Bewerten
              </button>
            </mat-card-actions>
          </mat-card>

          <!-- No Trainings -->
          <div class="no-trainings" *ngIf="trainings.length === 0 && !loading">
            <mat-icon class="large-icon">event_busy</mat-icon>
            <h3>Keine Trainings für dieses Datum</h3>
            <p>Wählen Sie ein anderes Datum oder erstellen Sie einen Trainingsplan.</p>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- FIT File Upload Tab -->
    <mat-tab label="FIT Datei hochladen">
      <div class="tab-content">
        <mat-card class="upload-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>upload_file</mat-icon>
              FIT Datei Upload
            </mat-card-title>
            <mat-card-subtitle>
              Laden Sie FIT-Dateien von Garmin, Polar oder anderen Geräten hoch
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <!-- Upload Area -->
            <div 
              class="upload-zone" 
              [class.drag-over]="dragOver"
              [class.uploading]="isUploading"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              *ngIf="!selectedFile">
              
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <h3>FIT-Datei hier ablegen</h3>
              <p>oder klicken Sie zum Auswählen</p>
              
              <input 
                type="file" 
                accept=".fit" 
                (change)="onFileSelected($event)"
                #fileInput
                style="display: none;">
              
              <button mat-raised-button color="primary" (click)="fileInput.click()">
                <mat-icon>folder_open</mat-icon>
                FIT-Datei auswählen
              </button>
            </div>

            <!-- Selected File -->
            <div class="selected-file" *ngIf="selectedFile && !isUploading">
              <mat-icon class="file-icon">description</mat-icon>
              <div class="file-info">
                <h4>{{ selectedFile.name }}</h4>
                <p>{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</p>
              </div>
              <button mat-icon-button color="warn" (click)="removeFile()">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <!-- Upload Progress -->
            <div class="upload-progress" *ngIf="isUploading">
              <mat-progress-bar mode="determinate" [value]="uploadProgress"></mat-progress-bar>
              <p>Datei wird hochgeladen... {{ uploadProgress }}%</p>
            </div>
          </mat-card-content>
          
          <mat-card-actions *ngIf="selectedFile && !isUploading">
            <button mat-button (click)="removeFile()">
              <mat-icon>cancel</mat-icon>
              Abbrechen
            </button>
            
            <button mat-raised-button color="primary" (click)="uploadFitFile()">
              <mat-icon>upload</mat-icon>
              Hochladen
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Feedback Modal -->
  <div class="feedback-overlay" *ngIf="showFeedbackForm" (click)="closeFeedbackForm()">
    <mat-card class="feedback-modal" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>rate_review</mat-icon>
          Training bewerten
        </mat-card-title>
        <mat-card-subtitle *ngIf="selectedTraining">
          {{ selectedTraining.name }}
        </mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="feedbackForm" (ngSubmit)="submitFeedback()">
          <!-- Completion Toggle -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Status</mat-label>
            <mat-select formControlName="completed">
              <mat-option [value]="true">Abgeschlossen</mat-option>
              <mat-option [value]="false">Nicht abgeschlossen</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Rating Slider -->
          <div class="rating-section">
            <label>Bewertung: {{ feedbackForm.get('rating')?.value }}/5</label>
            <mat-slider 
              min="1" 
              max="5" 
              step="1" 
              discrete
              showTickMarks
              formControlName="rating">
            </mat-slider>
            <div class="rating-preview">
              {{ getRatingStars(feedbackForm.get('rating')?.value || 5) }}
            </div>
          </div>

          <!-- Feedback Text -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Kommentar</mat-label>
            <textarea 
              matInput 
              formControlName="feedback"
              rows="4"
              placeholder="Wie war das Training? Notizen, Probleme, Erfolge...">
            </textarea>
          </mat-form-field>
        </form>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-button (click)="closeFeedbackForm()">
          <mat-icon>cancel</mat-icon>
          Abbrechen
        </button>
        
        <button 
          mat-raised-button 
          color="primary" 
          (click)="submitFeedback()"
          [disabled]="!feedbackForm.valid">
          <mat-icon>save</mat-icon>
          Speichern
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
